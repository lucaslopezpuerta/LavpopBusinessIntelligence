# Codebase Audit Report

## LAVPOP Business Intelligence Dashboard

**Audit Date:** December 12, 2025

**Version Audited:** 1.0.1

**Auditor:** Automated Code Analysis

 

---

 

## Executive Summary

 

This comprehensive audit evaluates the LAVPOP Business Intelligence (LAVPOP-BI) codebase across security, code quality, performance, testing, and maintainability dimensions. The application is a React-based business intelligence dashboard for a Brazilian laundromat business, featuring customer analytics, WhatsApp marketing campaigns, and operational metrics.

 

### Overall Assessment

 

| Category | Rating | Score |

|----------|--------|-------|

| **Architecture** | ‚úÖ Good | 8/10 |

| **Security** | ‚ö†Ô∏è Needs Attention | 5/10 |

| **Code Quality** | ‚úÖ Good | 7/10 |

| **Testing** | ‚ö†Ô∏è Low Coverage | 4/10 |

| **Performance** | ‚úÖ Good | 7/10 |

| **Documentation** | ‚úÖ Adequate | 6/10 |

| **Dependencies** | ‚úÖ Good | 7/10 |

 

**Overall Score: 6.3/10** - The codebase is functional and well-structured but has critical security vulnerabilities that require immediate attention.

 

---

 

## 1. Project Overview

 

### 1.1 Technology Stack

 

| Layer | Technology | Version |

|-------|------------|---------|

| Frontend | React | 18.3.1 |

| Build Tool | Vite | 5.4.11 |

| Styling | Tailwind CSS | 3.4.17 |

| Charts | Recharts, Nivo | 2.14.1, 0.87.0 |

| Database | Supabase (PostgreSQL) | 2.38.0 |

| Backend | Netlify Functions | Serverless |

| Testing | Vitest | 2.0.5 |

 

### 1.2 Application Structure

 

```

src/

‚îú‚îÄ‚îÄ views/          # 6 main dashboard tabs

‚îú‚îÄ‚îÄ components/     # 80+ React components

‚îÇ   ‚îú‚îÄ‚îÄ campaigns/  # 11 campaign components

‚îÇ   ‚îú‚îÄ‚îÄ customers/  # 2 customer components

‚îÇ   ‚îú‚îÄ‚îÄ intelligence/ # 7 analytics sections

‚îÇ   ‚îú‚îÄ‚îÄ drilldowns/ # 3 detail modals

‚îÇ   ‚îî‚îÄ‚îÄ ui/         # 12 design system components

‚îú‚îÄ‚îÄ utils/          # 30+ utility modules

‚îú‚îÄ‚îÄ contexts/       # 3 React contexts

‚îú‚îÄ‚îÄ hooks/          # 2 custom hooks

‚îî‚îÄ‚îÄ config/         # 2 configuration files

 

netlify/functions/  # 5 serverless functions

```

 

### 1.3 Key Features

 

- **Dashboard**: Real-time KPIs, operating cycles, financial metrics

- **Customers**: RFM segmentation, churn analysis, at-risk customer tracking

- **Campaigns**: WhatsApp marketing, automation rules, blacklist management

- **Intelligence**: Profitability forecasting, weather impact analysis, growth trends

- **Operations**: Machine utilization heatmaps, peak hours, performance tracking

 

---

 

## 2. Security Audit

 

### 2.1 Critical Vulnerabilities (Immediate Action Required)

 

#### CVE-CRITICAL-001: Hardcoded API Key in Client-Side Code

- **File**: `src/components/WeatherWidget_API.jsx:10`

- **Risk Level**: üî¥ CRITICAL

- **Issue**: Weather API key exposed in client-side JavaScript

- **Impact**: API key visible in browser dev tools, can be abused

- **Code**:

```javascript

const WEATHER_API_URL = 'https://weather.visualcrossing.com/...&key=FTYV4SM9NMMTJKVFLEGRCGWJ9&contentType=json';

```

- **Remediation**: Move API call to a backend Netlify function

 

#### CVE-CRITICAL-002: API Authentication Bypass

- **File**: `netlify/functions/supabase-api.js:50-62`

- **Risk Level**: üî¥ CRITICAL

- **Issue**: When `API_SECRET_KEY` environment variable is not set, all API requests are authenticated

- **Impact**: Complete API access without credentials during initial setup or misconfiguration

- **Code**:

```javascript

if (!API_SECRET) {

  console.warn('‚ö†Ô∏è WARNING: API_SECRET_KEY not configured. API is unprotected!');

  return true;  // CRITICAL: Returns authenticated without validation

}

```

- **Remediation**: Return `false` when secret is not configured, require API key in all environments

 

#### CVE-CRITICAL-003: Missing Webhook Signature Validation

- **File**: `netlify/functions/twilio-webhook.js:27,53-56`

- **Risk Level**: üî¥ CRITICAL

- **Issue**: Twilio webhook events processed without signature verification

- **Impact**: Attackers can forge webhook requests to manipulate delivery status, add numbers to blacklist

- **Remediation**: Implement Twilio webhook signature validation using the imported (but unused) crypto module

 

### 2.2 High Severity Issues

 

#### SEC-HIGH-001: Overly Permissive CORS

- **Files**:

  - `netlify/functions/twilio-whatsapp.js:26`

  - `netlify/functions/google-business.js:7`

  - `netlify/functions/twilio-webhook.js:32`

- **Issue**: `Access-Control-Allow-Origin: '*'` allows any domain

- **Remediation**: Restrict to specific trusted domains

 

#### SEC-HIGH-002: Development URLs in Production CORS

- **File**: `netlify/functions/supabase-api.js:36-37`

- **Issue**: `localhost:5173` and `localhost:3000` in CORS allowlist

- **Remediation**: Use environment-based CORS configuration

 

#### SEC-HIGH-003: Hardcoded Template SIDs

- **File**: `netlify/functions/campaign-scheduler.js:18-26`

- **Issue**: Meta WhatsApp template identifiers hardcoded in source

- **Remediation**: Move to environment variables or database configuration

 

### 2.3 Medium Severity Issues

 

| ID | Issue | File | Line |

|----|-------|------|------|

| SEC-MED-001 | Sensitive data in console logs | twilio-webhook.js | 58-62 |

| SEC-MED-002 | Unencrypted localStorage | contactTrackingService.js | Multiple |

| SEC-MED-003 | Insufficient phone validation | phoneUtils.js | 32-37 |

| SEC-MED-004 | DOM XSS in Selenium script | lavapop_automation.py | 424 |

| SEC-MED-005 | No webhook authentication | twilio-webhook.js | 29-51 |

 

### 2.4 Low Severity Issues

 

| ID | Issue | File |

|----|-------|------|

| SEC-LOW-001 | No rate limiting | All Netlify functions |

| SEC-LOW-002 | Missing security headers | All Netlify functions |

| SEC-LOW-003 | No CSRF protection | API endpoints |

| SEC-LOW-004 | Global function exposure | apiService.js:491-495 |

 

### 2.5 OWASP Top 10 Mapping

 

| OWASP Category | Issues Found |

|----------------|--------------|

| A01: Broken Access Control | CVE-CRITICAL-002, CVE-CRITICAL-003 |

| A02: Cryptographic Failures | SEC-MED-002, SEC-MED-004 |

| A05: Security Misconfiguration | CVE-CRITICAL-001, SEC-HIGH-001, SEC-HIGH-002 |

| A07: Authentication Failures | SEC-MED-005 |

| A08: Data Integrity Failures | CVE-CRITICAL-003 |

| A09: Logging Failures | SEC-MED-001 |

 

---

 

## 3. Code Quality Analysis

 

### 3.1 Code Duplication

 

**Issue**: Formatting functions duplicated across 14 files despite centralized `formatters.js`

 

**Affected Files**:

- `src/views/Intelligence.jsx:197` - inline formatCurrency

- `src/views/Campaigns.jsx:65` - inline formatCurrency

- `src/components/KPICards.jsx:162-173` - defines formatCurrency/formatNumber

- `src/components/campaigns/CampaignDashboard.jsx:52-63` - duplicate formatters

 

**Recommendation**: Enforce imports from `src/utils/formatters.js` via ESLint rule

 

### 3.2 Large Files Requiring Refactoring

 

| File | Lines | Complexity | Recommendation |

|------|-------|------------|----------------|

| `utils/intelligenceCalculations.js` | 1,555 | 14 exports, 50+ array operations | Split into domain modules |

| `utils/campaignService.js` | 1,371 | 29 exports, mixed concerns | Separate messaging, campaigns, automation |

| `components/campaigns/NewCampaignModal.jsx` | 1,287 | 19+ state variables | Extract step components |

| `components/campaigns/AutomationRules.jsx` | 887 | 15+ useState | Extract rule configuration components |

| `components/CustomerProfileModal.jsx` | 829 | 4-tab modal | Split into tab components |

 

### 3.3 Code Consistency Issues

 

| Issue | Count | Impact |

|-------|-------|--------|

| Loose equality (`==`/`!=`) | 692 | Potential type coercion bugs |

| Mixed `let`/`const` usage | Moderate | Inconsistent immutability |

| Inconsistent naming prefixes | Minor | `calculate` vs `get` vs `parse` |

 

### 3.4 Positive Findings ‚úÖ

 

- **Error Handling**: 116 try-catch blocks across 32 files

- **Async/Await**: 306 proper usages across 24 files

- **Memory Management**: Event listeners properly cleaned up with useEffect

- **Hook Usage**: 234 React hooks with proper dependency arrays

- **No Unused Imports**: Clean import statements throughout

 

### 3.5 Deprecated Code

 

- **File**: `src/components/KPICards.jsx`

- **Status**: Marked DEPRECATED in comments (lines 1-8)

- **Replacement**: `KPICardsGrid.jsx`

- **Action**: Remove deprecated file

 

---

 

## 4. Testing Coverage Analysis

 

### 4.1 Current Test Files

 

| File | Lines | Tests | Coverage Area |

|------|-------|-------|---------------|

| `phoneUtils.test.js` | 254 | 25 | Phone validation, normalization |

| `campaignService.test.js` | 356 | 30 | Campaign CRUD, automation rules |

| `blacklistService.test.js` | 389 | 35 | Blacklist management, CSV import/export |

 

**Total**: 3 test files, ~90 test cases

 

### 4.2 Coverage Gaps

 

| Category | Files | Tests | Coverage |

|----------|-------|-------|----------|

| Utility Functions | 30+ | 3 | ~10% |

| React Components | 80+ | 0 | 0% |

| Views | 6 | 0 | 0% |

| Netlify Functions | 5 | 0 | 0% |

| Custom Hooks | 2 | 0 | 0% |

| Contexts | 3 | 0 | 0% |

 

### 4.3 Untested Critical Modules

 

| Module | Risk Level | Recommendation |

|--------|------------|----------------|

| `supabaseLoader.js` | High | Add integration tests |

| `businessMetrics.js` | High | Add unit tests for calculations |

| `intelligenceCalculations.js` | High | Add comprehensive unit tests |

| `apiService.js` | High | Add mock-based tests |

| All Netlify functions | Critical | Add serverless function tests |

 

### 4.4 Testing Recommendations

 

1. **Priority 1**: Add tests for `businessMetrics.js` and `customerMetrics.js` (business-critical calculations)

2. **Priority 2**: Add component tests for data-displaying components using React Testing Library

3. **Priority 3**: Add integration tests for Netlify functions

4. **Goal**: Achieve 60%+ code coverage within 3 months

 

---

 

## 5. Performance Analysis

 

### 5.1 Optimizations in Place ‚úÖ

 

| Optimization | Implementation | Files |

|--------------|----------------|-------|

| Code Splitting | `React.lazy()` with Suspense | `App.jsx` |

| Memoization | `useMemo()` for calculations | All views |

| Vendor Chunking | Separate React, charts, icons | `vite.config.js` |

| Data Caching | IndexedDB + localStorage | `idbStorage.js`, `dataCache.js` |

| Pagination | 25 items/page | `CustomerCard` lists |

 

### 5.2 Vite Build Configuration

 

```javascript

// vite.config.js

manualChunks: {

  vendor: ['react', 'react-dom'],

  charts: ['recharts'],

  icons: ['lucide-react'],

}

```

 

### 5.3 Performance Concerns

 

| Issue | Location | Impact | Recommendation |

|-------|----------|--------|----------------|

| Large bundle (Nivo) | Multiple chart files | ~200KB+ | Consider tree-shaking or alternative |

| No image optimization | Public assets | Load time | Add WebP conversion, lazy loading |

| Synchronous localStorage | Multiple utils | UI blocking | Use async IndexedDB consistently |

| No service worker | Global | Offline/caching | Add PWA capabilities |

 

### 5.4 Bundle Size Estimate

 

| Chunk | Estimated Size |

|-------|---------------|

| vendor (React) | ~45KB |

| recharts | ~150KB |

| nivo | ~200KB |

| lucide-react | ~50KB |

| app code | ~300KB |

| **Total** | **~750KB** (gzipped: ~200KB) |

 

---

 

## 6. Dependencies Audit

 

### 6.1 Production Dependencies

 

| Package | Version | Status | Notes |

|---------|---------|--------|-------|

| react | 18.3.1 | ‚úÖ Current | |

| react-dom | 18.3.1 | ‚úÖ Current | |

| @supabase/supabase-js | 2.38.0 | ‚ö†Ô∏è Minor behind | Latest: 2.45.x |

| recharts | 2.14.1 | ‚úÖ Current | |

| @nivo/* | 0.87.0 | ‚úÖ Current | |

| @tremor/react | 3.18.7 | ‚úÖ Current | |

| framer-motion | 11.11.17 | ‚úÖ Current | |

| lucide-react | 0.553.0 | ‚úÖ Current | |

| papaparse | 5.5.3 | ‚úÖ Current | |

| embla-carousel-react | 8.3.0 | ‚úÖ Current | |

 

### 6.2 Development Dependencies

 

| Package | Version | Status |

|---------|---------|--------|

| vite | 5.4.11 | ‚úÖ Current |

| vitest | 2.0.5 | ‚úÖ Current |

| eslint | 9.36.0 | ‚úÖ Current |

| tailwindcss | 3.4.17 | ‚úÖ Current |

| @testing-library/react | 16.0.0 | ‚úÖ Current |

 

### 6.3 Security Vulnerabilities

 

**npm audit status**: No critical vulnerabilities detected in dependencies

 

### 6.4 Dependency Recommendations

 

1. **Update**: `@supabase/supabase-js` to latest (2.45.x)

2. **Consider**: Adding `@tanstack/react-query` for data fetching (improves caching, reduces boilerplate)

3. **Evaluate**: Whether both Recharts AND Nivo are needed (significant bundle overlap)

 

---

 

## 7. Configuration Analysis

 

### 7.1 ESLint Configuration

 

**File**: `eslint.config.js`

 

```javascript

// Current rules

'no-unused-vars': ['error', { varsIgnorePattern: '^[A-Z_]' }]

```

 

**Missing Recommended Rules**:

- `eqeqeq` - Enforce strict equality

- `no-console` - Warn on console statements in production

- `react/prop-types` - Validate component props (or migrate to TypeScript)

 

### 7.2 Vite Configuration

 

**File**: `vite.config.js`

 

‚úÖ **Good**:

- Source maps disabled in production

- Manual chunk splitting configured

 

‚ö†Ô∏è **Missing**:

- Environment-specific configs

- Bundle analyzer plugin for monitoring

 

### 7.3 Netlify Configuration

 

**File**: `netlify.toml`

 

‚úÖ **Good**:

- Functions directory configured

- SPA redirect rule in place

- Scheduled function for campaign-scheduler (*/5 * * * *)

 

‚ö†Ô∏è **Missing**:

- Security headers configuration

- Cache control headers

- Function timeout settings

 

### 7.4 Recommended `netlify.toml` Additions

 

```toml

[[headers]]

  for = "/*"

  [headers.values]

    X-Frame-Options = "DENY"

    X-Content-Type-Options = "nosniff"

    X-XSS-Protection = "1; mode=block"

    Referrer-Policy = "strict-origin-when-cross-origin"

    Permissions-Policy = "geolocation=(), microphone=(), camera=()"

```

 

---

 

## 8. Architecture Assessment

 

### 8.1 Strengths

 

| Aspect | Assessment |

|--------|------------|

| **Component Organization** | Well-organized by feature/domain |

| **Data Flow** | Clear unidirectional flow (Supabase ‚Üí Loader ‚Üí Views ‚Üí Components) |

| **Context Usage** | Appropriate for theme, navigation, sidebar state |

| **Offline Support** | IndexedDB caching with CSV fallback |

| **Code Splitting** | Lazy-loaded views improve initial load |

 

### 8.2 Areas for Improvement

 

| Aspect | Current State | Recommendation |

|--------|---------------|----------------|

| **Type Safety** | JavaScript only | Migrate to TypeScript |

| **State Management** | Props drilling | Consider Zustand for complex state |

| **API Layer** | Scattered calls | Centralize with React Query |

| **Error Boundaries** | Single ErrorBoundary | Add per-view boundaries |

| **Internationalization** | Hardcoded Portuguese | Add i18n framework if expansion planned |

 

### 8.3 Recommended Architecture Changes

 

```

Current:                          Recommended:

App.jsx                           App.tsx

‚îú‚îÄ‚îÄ Views (props drilling)        ‚îú‚îÄ‚îÄ Views (context/query hooks)

‚îú‚îÄ‚îÄ Components                    ‚îú‚îÄ‚îÄ Components

‚îú‚îÄ‚îÄ utils/*.js                    ‚îú‚îÄ‚îÄ services/  (API/business logic)

‚îî‚îÄ‚îÄ contexts/                     ‚îú‚îÄ‚îÄ hooks/     (data fetching)

                                  ‚îú‚îÄ‚îÄ types/     (TypeScript interfaces)

                                  ‚îî‚îÄ‚îÄ contexts/  (global state)

```

 

---

 

## 9. Recommendations Summary

 

### 9.1 Immediate Actions (This Week)

 

| Priority | Action | Owner | Effort |

|----------|--------|-------|--------|

| üî¥ P0 | Remove hardcoded Weather API key | Dev | 2h |

| üî¥ P0 | Fix API authentication bypass | Dev | 1h |

| üî¥ P0 | Implement Twilio webhook signature validation | Dev | 4h |

| üî¥ P0 | Restrict CORS to specific domains | Dev | 2h |

| üü° P1 | Add security headers to Netlify config | Dev | 1h |

 

### 9.2 Short-Term Actions (This Month)

 

| Priority | Action | Effort |

|----------|--------|--------|

| üü° P1 | Move template SIDs to environment variables | 2h |

| üü° P1 | Add rate limiting to API endpoints | 4h |

| üü° P1 | Consolidate formatter usage across codebase | 4h |

| üü° P1 | Add unit tests for businessMetrics.js | 8h |

| üü° P1 | Remove deprecated KPICards.jsx | 1h |

 

### 9.3 Medium-Term Actions (This Quarter)

 

| Priority | Action | Effort |

|----------|--------|--------|

| üü¢ P2 | Refactor intelligenceCalculations.js into modules | 16h |

| üü¢ P2 | Split NewCampaignModal into step components | 8h |

| üü¢ P2 | Achieve 40% test coverage | 40h |

| üü¢ P2 | Migrate to TypeScript | 80h |

| üü¢ P2 | Add ESLint strict equality rule | 4h |

 

### 9.4 Long-Term Actions (Next Quarter)

 

| Priority | Action | Effort |

|----------|--------|--------|

| üîµ P3 | Implement React Query for data fetching | 24h |

| üîµ P3 | Add PWA support with service worker | 16h |

| üîµ P3 | Consolidate charting libraries (choose Recharts OR Nivo) | 24h |

| üîµ P3 | Achieve 60% test coverage | 80h |

 

---

 

## 10. Risk Assessment

 

### 10.1 Business Risks

 

| Risk | Likelihood | Impact | Mitigation |

|------|------------|--------|------------|

| API key abuse | High | Medium | Move to backend immediately |

| Unauthorized API access | High | High | Fix auth bypass |

| Webhook spoofing | Medium | High | Add signature validation |

| Data breach via XSS | Low | High | Add security headers |

 

### 10.2 Technical Debt

 

| Category | Severity | Items |

|----------|----------|-------|

| Security | Critical | 3 critical, 3 high vulnerabilities |

| Testing | High | <10% coverage, no component tests |

| Code Quality | Medium | Large files, duplicate code |

| Dependencies | Low | Minor version updates needed |

 

---

 

## 11. Conclusion

 

The LAVPOP-BI codebase demonstrates solid architectural decisions and good development practices in many areas. The React component organization is clean, error handling is comprehensive, and the application provides substantial business value with its analytics and campaign management features.

 

However, **critical security vulnerabilities require immediate attention** before any production deployment. The hardcoded API key, authentication bypass, and missing webhook validation represent significant risks that could expose customer data or allow unauthorized system access.

 

**Key Priorities**:

1. **Security First**: Address all critical and high-severity security issues immediately

2. **Testing**: Increase test coverage from <10% to at least 40% to ensure reliability

3. **Code Quality**: Refactor large files and eliminate code duplication

4. **Maintenance**: Consider TypeScript migration for long-term maintainability

 

With focused effort on these areas, the codebase can achieve enterprise-grade quality and security standards.

 

---

 

## Appendix A: Files Audited

 

- **Source Files**: 100+ JavaScript/JSX files

- **Netlify Functions**: 5 serverless functions

- **Test Files**: 3 test suites

- **Configuration Files**: 6 config files

 

## Appendix B: Tools Used

 

- Manual code review

- Pattern analysis via grep/glob

- Dependency analysis via package.json

- Architecture analysis

 

---

 

*Report generated by automated code analysis. For questions, refer to the specific file paths and line numbers provided.*
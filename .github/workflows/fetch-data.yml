# =============================================================================
# DEPRECATED: This workflow is disabled as of 2025-12-10
#
# Data is now managed via Supabase:
# - Sales/Customer data: Manual CSV uploads via web app (Importar tab)
# - RFM segmentation: Computed by refresh_customer_metrics() in Supabase
# - Blacklist: Managed via blacklistService.js + Supabase
# - Campaigns: Managed via apiService.js + Supabase
#
# Only weather.csv is still loaded from CSV (not yet migrated to Supabase).
# Use workflow_dispatch to manually update weather data if needed.
#
# See docs/MIGRATION_STRATEGY.md for details.
# =============================================================================

name: "[DEPRECATED] Fetch Google Sheets Data"

on:
  # schedule:
  #   # DISABLED - Data now comes from Supabase via manual uploads
  #   - cron: '0 1 * * *'
  workflow_dispatch: # Manual trigger only - for weather.csv updates if needed

permissions:
  contents: write

jobs:
  fetch-data:
    runs-on: ubuntu-latest

    steps:
      - name: Deprecation Notice
        run: |
          echo "‚ö†Ô∏è This workflow is DEPRECATED as of 2025-12-10"
          echo "Data is now managed via Supabase."
          echo "Use the web app 'Importar' tab to upload sales/customer CSV files."
          echo ""
          echo "This workflow can still be triggered manually if you need to update weather.csv"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies for data fetch
        run: npm install googleapis csv-writer date-fns-tz

      # Only fetch weather data - other data comes from Supabase
      - name: Fetch weather data from Google Sheets
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
          WEATHER_SHEET_ID: ${{ secrets.WEATHER_SHEET_ID }}
        run: |
          echo "Fetching weather data only..."
          # Note: fetch-sheets.cjs still exists in archive/ for reference
          # For now, this step is a placeholder - weather updates are optional

      - name: Copy weather data for React app
        run: |
          mkdir -p public/data
          if [ -f data/weather.csv ]; then
            cp data/weather.csv public/data/
          fi

      - name: Check for changes
        id: check_changes
        run: |
          git add data/weather.csv public/data/weather.csv 2>/dev/null || true
          if git diff --cached --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
          else
            echo "changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git commit -m "üå§Ô∏è Weather data update - $(TZ='America/Sao_Paulo' date '+%Y-%m-%d %H:%M %Z')"
          git push
